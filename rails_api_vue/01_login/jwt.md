# JWTについて

## JWT

JWT(ジェット)...JSON Web Tokenの略であり、Cookiesを使用せずに認証機能を実現させるための技術。

従来のWebアプリケーションでは、認証情報をCookiesを利用して保持し、ログイン情報を保つことを表現している。

APIでは、ブラウザを介さないことから、Cookiesを使用したセッションの保持が行えないため、認証時に生成したトークンを使って認証済み(ログイン状態)であることを表現できる

JWTの実態は、`JSONオブジェクトをエンコードした文字列`で、この文字列のことを`トークン`と呼ぶ

```JSON
23jaihsofhasifhisahf. //ヘッダ
sajj4htwniio5ihaiugft7t384hit4ht. //ペイロード
hasihfi44068048w4--w39uwoeihgusagyfyasfy  //署名
```

## トークンを３つに分解

JWTが発行するトークンは３つに分類することができ、それぞれがぞれぞれの情報を保持している

`<ヘッダ要素>.<ペイロード要素>.<署名要素>`

### ヘッダ要素

最初の文字列をヘッダと呼ぶ

ヘッダには、トークンのタイプや、使用されている署名アルゴリズの情報を持っている

```JSON
// エンコード => デコード
23jaihsofhasifhisahf.
=> { "alg": "HS256", "type": "JWT"}
```

alg: HS256...下記の通り、開発者が鍵を使用するユーザーを制御できるアルゴリズムを使うことわかる

#### HS256 RS256

トークンのヘッダ要素内にあるアルゴリズムである、HS256やRS256について

これらは、IDプロバイダがJWTに署名するために使用するアルゴリズムのこと。

この署名するとは、トークンの受信者が、トークンが改ざんされていないことを検証するための仕組み。

#### RS256

RS256...非対称アルゴリズムであり、公開鍵/秘密鍵のペアを使用する。IDプロバイダは署名を生成するために使用される秘密鍵をもち、JWTのコンシューマーは、署名を検証するための公開鍵を取得する。秘密鍵とは対照的に、公開鍵は保護されている必要がないため、ほとんどのIDプロバイダは、IDのコンシューマーが(通常はメタデータURLを介して)入手して使用できるようにする

- 開発者がクライアントを制御できない場合
- 秘密鍵を保護する方法がない場合

の場合は、RS256が適している


#### HS256

HS256...対象アルゴリズムであり、２つの当事者間で共有される１つの(秘密)鍵のみを使用する。署名を静止絵して検証するために同じ鍵が使用されるので、鍵が侵害されていないことを保証するように注意が必要。JWTを使用するアプリケーションを開発する場合は、誰が秘密鍵を使用するかを開発者が制御できるため、HS256を安全に使用することができる

<br>

### ペイロード

`ペイロード`...2番目の文字列のこと。任意の情報を指定することができる

基本的には、このペイロードをカスタマイズしてユーザー認証に必要な情報を埋め込む

```JSON
// エンコード => デコード

sajj4htwniio5ihaiugft7t384hit4ht.
=> { "exp"=>1600596431, "sub"=>1, "name"=>"user0" }
```

exp, sub...それぞれの値のことを`クレーム`と呼ぶ

デフォルトで指定されている値を`予約クレーム`、使用者が任意に指定した値を`パブリッククレーム`と呼ぶ

exp...Expiration Time つまり、JWTの有効期限を示すクレーム。expクレームを処理する際には、expが現在時刻以前でないことを確認しなければならない

sub...Subject つまり、JWTの主語となる主体の識別子のこと。JWTに含まれるクレームは、通常このsubについて述べたもの。

[JWTについてまとまってるサイト](https://openid-foundation-japan.github.io/draft-ietf-oauth-json-web-token-11.ja.html)


### 署名

`署名`...３番目の文字列。署名情報が入っている

この署名は、トークンが改竄・変更されていないことを確認するために使用される

```JSON
// エンコード => デコード

hasihfi44068048w4--w39uwoeihgusagyfyasfy
=> HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  your-256-bit-secret
)
```


さらっと見たけどさっぱり[HMACSHA256などについて](https://qiita.com/TakahikoKawasaki/items/8f0e422c7edd2d220e06)

<br>

## JWTでの認証の流れ

[![Image from Gyazo](https://i.gyazo.com/84539d7beff745e16027063d73e69e6f.png)](https://gyazo.com/84539d7beff745e16027063d73e69e6f)

1. フロント側からログインフォームからユーザー名・メアド・パスワードなどのログインに必要な情報を送る
2. その情報をバックエンドで受け取り、登録しているユーザー名とパスワードが一致していれば、tokenを発行してレスポンスする。発行されたtokenは秘密鍵で暗号化してJWTとして送られる
3. 送られてきたトークンをlocalstorageに保存して、常に使える状態にする。vue.jsならvuexに, react.jsならreduxに保存する。ログインしていないとできないリクエストは、このトークンをヘッダーに乗せてリクエストを送る
4. バックエンド側は、リクエストのヘッダー情報を元に認証・認可を行い、レスポンスを返す
5. 返ってきたレスポンスをフロント側で表示する

### まとめ

以上がJWTの大まかな機能や概要について

[次の記事で、実装例についてまとめていく](https://github.com/koteharyu/TIL/blob/main/rails_api_vue/jwt_detail.md)
