# chapter3 HTTPでやり取りする仕組み

<br>

## 01 HTTPメッセージ

<br>

* HTTPメッセージによる「要求」と「反応」

  `HTTPリクエスト`（Webブラウザからの要求）と`HTTPレスポンス`（Webサーバーからの反応）を繰り返すことでWebページの閲覧を可能にしている。HTTPでは基本的に1つの`HTTPリクエスト`に対して1つの`HTTPレスポンス`を返す。

* HTTPメッセージの構成

  リクエスト時は「リクエスト行」、レスポンス時は「レスポンス行」

|HTTPメッセージの構成|
----
|リクエスト行、ステータス行|
|メッセージヘッダー|
|空行|
|メッセージボディー|

<br>

## 02 HTTPリクエスト/HTTPレスポンス

<br>

* HTTPリクエスト
  
  リクエスト行・メッセージヘッダー・メッセージボディの3つから構成される。

  * リクエスト行 : 「情報を取得したい」や「情報を送信したい」などのWebサーバーに処理して欲しいことを記述する
  * メッセージヘッダー : Webブラウザの種類やバージョン、対応するデータ形式など服的情報を記述
  * メッセージボディ : Webページ内のフォーム欄などに入力したテキストなどをWebサーバーへ送る目的で使用

* HTTPレスポンス

  WebブラウザからHTTPリクエストを受け取ったWebサーバーはリクエストを処理し、HTTPレスポンスとして反応する。


  レスポンス行・メッセージヘッダー・メッセージボディの3つから構成される。

  * レスポンス行 : Webブラウザから受け取ったHTTPリクエストに対してWebサーバー内で行った処理の結果を記述
  * メッセージヘッダー : Webサーバーの種類や情報、返信するデータのタイプ、データの圧縮方法などの情報を記述
  * メッセージボディ : HTMLや画像などのデータを格納する場所

## 03 HTTPメソッド

<br>

| HTTPメソッド名 | 説明 |
|:----:|:----:|
|HEAD|HTTPヘッダーの情報のみを取得するHTTPメソッド。データの更新やデータのサイズ
のみを取得したい場合に利用する|
|GET|HTMLファイルや画像などのデータを取得する場合に利用。HTTPに置いて必須のメソッド|
|POST|フォームに入力したパスワードなどのデータを転送する際に利用|
|PUT|データをアップロードする際に使用|
|DELETE|指定したデータを削除する場合に使用。|
|CONNECT|Webサーバーに接続するまでに別のサーバーを中継する場合に使用|
|OPTIONS|利用できるHTTPメソッドを問い合わせる際に使用。制限されているメソッドを調べるため|
|TRACE|WebブラウザとWebサーバーの経路を確認する際に使用|


<br>

***PUT DELETE CONNECT TRACEメソッドを悪用した攻撃があるため利用を制限しているブラウザが多い***

* GETとPOSTの違い（ログインする場合）

  * GETメソッドの場合、URLにユーザー名やパスワードがURLに含まれるため、それらの情報がブラウザに残ってしまうのでNG
  * パスワード情報に限らず、メアドや住所などの個人情報をWebサーバーに送る際はPOSTメソッドを使用するように

<br>

## 04 ステータスコード

<br>

`ステータスコード` : HTTPレスポンスに含まれるリクエストに対する処理結果のこと

|番台|説明|
|:-:|:-:|
|100|HTTPリクエストを処理中であることを通知|
|200|HTTPリクエストに対して、正常な処理が行われた場合|
|300|WebサイトのURLが変更されているなど、転送処理がブラウザで必要なことを通知|
|400|クライアントのエラーであることを通知。リクエストされたファイルなどがサーバー上にない場合。「404 Not Found」|
|500|Webサーバーのエラーだと通知。アクセス集中やメンテナンスなど|

<br>

|有名なコード|表示|説明|
|:-:|:-:|:-:|
|100|continue|リクエスト継続中|
|200|OK|リクエストが正常に処理された|
|301|Moved Parmanetly|リクエストされたコンテンツが移動した|
|302|Found|リクエストされたコンテンツが一時的に移動（別の場所で発見された）した|
|304|Not Found|リクエストされたコンテンツが未更新である。Webブラウザに一時保存されたコンテンツが表示される|
|400|Bad Request|リクエストが不正である|
|404|Not Found|リクエストされたコンテンツが未検出である|
|500|Internal Server Error|リクエスト処理中にサーバー内部でエラーが発生|
|503|Service Unavailable|アクセス集中やメンテナンスにより一時的に処理が不可能である|

<br>

## 05 メッセージヘッダー

<br>

`メッセージヘッダー`は複数の`ヘッダーフィールド`(行)から成り立つ。ヘッダーフィールドは以下の4つに分類できる。

* 一般ヘッダーフィールド
  
  HTTPリクエストとレスポンスの両者に含まれ、HTTPメッセージが作成された日付を示す`Date`などがある

* リクエストヘッダーフィールド

  HTTPリクエストのみに含まれ、Webブラウザなどのクライアントの固有情報を示す`User-Agent`がある。これを見てスマホならスマホに、PCならPCに合うWebサイトを要求する

* レスポンスヘッダーフィールド

  HTTPレスポンスのみに含まれ、Webサーバー機能を提供するプロダクト情報を示す`Server`がある。ただし、詳細なプロダクト情報が分かってしまうと攻撃対象になる可能性が高まるため、`Server`が示す情報を制限することも可能

* エンティティヘッダーフィールド

  HTTPリクエスト、レスポンス両者に含まれる。一般ヘッダーフィールがHTTPメッセージ全体に対しての付加情報を示すのに対して、エンティティヘッダーフィールドは`Content-Type`などのメッセージボディに含まれるデータの付加情報を示す。

<br>

## 06 TCPによるデータ通信

* `TCP(Transmission Control Protocol)`

  TCPはWebサイトの閲覧だけでなく、メールの送受信やファイル転送などさまざまなデータ転送に利用される

  TCPではクライアントとサーバーが通信可能か確認し、`コネクション`と呼ばれる通信経路を確立した上でデータのやり取りを行う。`コネクションの確立は3回`である。

  1. クライアントからの接続要求（`SYN`）

      クライアントからサーバーに対して`SYNパケット`というデータを送る

  2. クライアントに対して確認応答（`ACK`）及び、サーバーからの接続要求（`SYN`）

      クライアントからの`SYN`を受け取ったサーバーは受け取った証として`ACK`をクライアントに返す。プラス接続要求である`SYN`も送る

  3. サーバーに対して確認応答（`ACK`）

      クライアントはサーバーからの`SYN`の返答として`ACK`を送り、コネクションが確立が完了

  ***以上の工程でお互いに通信可能であることが確認できたので、データのやり取りが始まる***

* TCPが信頼性が高いわけ

  `コネクションの確立`だけでなく、`再送制御`と`順序制御`を行っているため

  * `再送制御`とは、一定時間ACKの反応がない場合、データを再送する仕組み
  * `順序制御`とは、SYNの順序が入れ替わって届いた場合、順序番号を見て、正しいデータに組み立てる仕組み

<br>

## 07 HTTP/1.1のやり取り

<br>

* `HTTPキープアライブ`

  HTTP1.1以前では1つの処理の中でコネクションを確立し直していたため処理効率が悪かったことに対してHTTP1.1以降ではHTTPキープアライブの機能が搭載され、HTTPリクエスト毎にコネクションを確立する必要がなく、コネクションを継続して利用する方式を取ることができるため、効率アップ。

* `HTTPパイプライン`

  HTTPレスポンスを待つことなく複数のHTTPリクエストを送信可能にする機能

  ただし、HTTPリクエストの順番通りにレスポンスを返さなければならないという制約がある

  <br>

  ## 08 HTTP/2のやり取り

  <br>

  HTTP/2はGoogleが提案したSPDYという通信の高速化を目的としたプロトコルがベースとなっている。

* `ストリーム`

  仮想的な通信経路を複数生成し、それぞれのストリーム内でHTTPリクエストとHTTPレスポンスのやり取りを可能としている
  個々のストリームは独立しており、並行してHTTPリクエストとHTTPレスポンスのやり取りができるためHTTPパイプラインで問題となっていたHTTPレスポンスの待ち状態が発生することがなくなり、より高速で効率よくデーだのやり取りを実現できる

<br>

## 09 HTTP/2での改良点

<br>

HTTP/2ではストリームの多重化以外に下記の改良点がある

* バイナリ形式の利用

  HTTP/2ではバイナリ形式のデータをそのまま扱うことができるため変換処理にかかる時時間とWebブラウザ、Webサーバーへの負担を軽減することが可能に
* ヘッダー圧縮

  従来のヘッダー情報には重複した情報が含まれていたが、ヘッダー情報の中から差分だけ送るHPACKと呼ばれる圧縮方式を利用することでデータ転送量を削減できる
* サーバープッシュ

  WebブラウザからのHTTPリクエスト内容を基にWebサーバー側で必要なファイルを判断し、事前にWebブラウザに送信することが可能に

  ex）WebブラウザがWebページのHTMLファイルをリクエストした際に、HTMLファイル内に画像が埋め込まれていた場合、Webサーバーは画像データに対するHTTPリクエストをWebブラウザから受けなくても、事前にデータを転送する仕組み

  <br>

  ## 10 HTTPSの仕組み

  <br>

* `HTTPS(HTTP over SSL/TLS)` : HTTPの通信に置いて、暗号化方式である`SSL（Secure Socekts Layer）`や`TLS（Transport Layer Security）`を利用することでWebサイトを安全に使うことができる仕組み

####安全性を確保する仕組み
* 盗聴防止(暗号化通信)

  データを暗号化することで盗聴を防止

* 改ざん防止

  メッセージダイジェストを利用して送信するデータのハッシュ値を計算して、データと一緒に送ることで、データの改ざんに遭遇しても、Webサーバーが受け取ったデータのハッシュ値を計算して値が異なっていれば改ざんされたとわかる仕組み

* なりすまし防止

  HTTPS通信の場合、WebサーバーはWebブラウザに対してSSlサーバー証明書を送付する。Webブラウザは受け取ったSSLサーバー証明書を見て、Webサイトの運営もとを確認することができる仕組み

  <br>

## 11 HTTPSのやり取り

<br>

HTTPSでの通信を開始するには`SSl/TLSハンドシェイク`と呼ばれる4つのフェーズを行う必要がある
1. 暗号化方式の決定
2. 通信相手の証明
3. 鍵の交換
4. 暗号化方式の確認
   
***P.71参照***

<br>

## 12 ステートレスとステートフル

<br>

* `ステートレス`

  HTTPではリクエスト/レスポンスの1往復のやり取りが完結された処理とみなされ、直前にやり取りした相手の状態を毎回リセット（忘れる）

* `ステートフル`

  直前にやり取りした相手の状態を、以降のやり取りでも覚えていること

  ただし、サーバーは1度に多くのクライアント状態を保持する必要があり、これがかなりの高負担である

* まとめ

  ステートレスなプロトコルでも、自分を特定する情報を毎回伝えるようにすれば、ステートフルと同じ結果が得られる

<br>

## 13 Cookie

<br>

ステートレスなHTTPプロトコルに置いて、WebブラウザとWebサーバーの一連のやり取りの状態を保持・管理する仕組みを`Cookie`と呼ぶ

* Cookieのやり取り

  Webサーバーへ接続してきたWebブラウザに対してコンテンツなどと一緒にWebブラウザに保持してもらいたい情報をCookieとして送る。Cookieを受け取ったWebブラウザは次にWebサーバーに接続する際に保存していたCookieを送信することで、サーバーは接続してきた相手を識別することができる

  Cookieの送信にはメッセージヘッダーが利用され、`WebサーバーはHTTPレスポンスにSet-Cookie`を含めることでCookieを送信でき、`WebブラウザはHTTPリクエストにCookiヘッダー`を含めることで送信できる。

  Set-Cookieヘッダーにはオプションで有効期限（Expire）を設定したり、HTTPSのみ利用してCookieを送信する設定をしたりできる

* セッションCookie

  有効期限が設定されていないCookieは、Webブラウザが閉じられると同時に削除される。このようなCookieを`セッションCookie`と呼ぶ。

  <br>

## 14 セッション

<br>

`セッション`とは、ショッピングサイトにて「商品を選ぶ」「買い物かごに追加する」「買い物かごの中身を確認する」「購入する」といったWebブラウザとWebサーバーの一連の関連性のある処理の流れのこと

セッションの管理は、Webサーバーで生成した`セッションID`で行っている。WebブラウザはセッションIDをCookieに含めてWebサーバーとやり取りを行う

<br>

## 15 URI(Uniform Resouce Identifier)

<br>

`URI`とは、情報やデータなどのリソースを識別するための記述記法のこと。URIは、コンピューターが扱うリソース以外にも、人や会社、書籍などあらゆるリソースを示すことができる








