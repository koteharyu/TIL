# chapter5 Webアプリケーションの基本

<br>

## 01

<br>

- `Webアプリケーション`とは、ネットワークを介してWebブラウザ上で動作するアプリケーションのこと
- Webアプリケーションは基本的に`3層構造(3層アーキテクチャ)`な構造になっている
- 3層構造は階層構造のため、最上層のプレエンテーション層と最下層のデータ層が直接やり取りすることはない
- アプリケーション層はプレゼンテーション層とデータ層の仲介を担当
- 3層構造を取ることで負荷分散を可能とする
- 3層構造を取ることで改修範囲を限定できる
  - データ層の改修の際に、プレゼンテーション層とアプリケーション層は触らなくてすむ

<br>

- 3層構造の内訳
  - `プレゼンテーション層`
    - ユーザーインターフェースとなる。WebブラウザとWebサーバーが役割を担う
  - `アプリケーション層`
    - 業務処理と担当。アプリケーションサーバーが役割を担当
  - `データ層`
    - データ処理や保管を行う。データベースサーバーが担当

<br>

## 02

<br>

- `MVCモデル`とは、アプリケーション構造の考え方の一つである。
- `Model`は、アプリケーションの扱うデータと業務処理を担当
- `View`は、ユーザーへの出力処理を担当
- `Controller`は、必要な処理をModelやViewに伝える

<br>

- 3層構造と異なり、MVCモデルの各要素が相応にやりとりを行う

<br>

## 03

<br>

- `フレームワーク`とは、サーバーサイド・スクリプトなどのプログラム開発の際のメインの処理となる、データの受け取り処理や、データベースとの通信処理などの一連の流れを「雛形」として準備し、開発者を楽にするもの
- フレームワークを用いることで、共同作成する際の力量の差による品質のばらつきを出しにくくできる

<br>

## 04

<br>

`Webサーバー`とは、Webアプリケーションにおいて、Webクライアントに対する窓口の役割を果たすプログラム

- Webクライアントからのリクエストを受け取り静的コンテンツを配信する
- 動的処理の必要なものがあればサーバーサイド・プログラムと連携し、処理の結果として作られたHTMLファイルをWebブラウザへ転送する
- もしWebサーバーが壊れたら、壊れたことすら通知できなくなる

<br>

`冗長化`とは、サーバー機器の数を増やし、1台あたりの負担を軽減させ、万が一1台が故障しても別のサーバーでサービスを継続できるようにする仕組み

<br>

求められるサーバー機器の性能

|場合|必要な性能|
|-|-|
|静的ページリクエスト多めなアプリ|静的ページを読み込むためのハードディスクの読み取りが速く、ハードディスクの読み取りをサポートするメモリの容量が大きいもの|
|動的ページリクエスト多めなアプリ|アプリケーションサーバーへのデータ連携処理を速くするため、高い性能のCPU|

<br>

静的コンテンツの配置

静的コンテンツは必ずしも、Webサーバーと同じサーバー上に配置する必要はなく、Webサーバーからアクセスできる場所にあれば問題ないが、その分、レスポンスに時間がかかってしまう。そのため複数台のWebサーバーが起動している時は、Webサーバー同士が同じコンテンツを持つように都度同期する必要がある

<br>

## 05

<br>

`webクライアント`とは、Webサーバーとやりとりを行い、Webシステムを利用するためのプログラムのこと。`ユーザーとWebサーバーとの橋渡し`。Webブラウザなど

- 主な機能
  - Webサーバーへリクエストを送る
  - Webサーバーからのレスポンスを受け取り、解釈する

<br>

- スマホアプリなどを`クライアントプログラム`・`専用クライアント`・`専用ブラウザ`と呼ぶ
  - デスクトップアプリ
  - スマホアプリ

<br>

## 06

<br>

`アプリケーションサーバー(APサーバー)`とは、Webアプリケーションの中核となる業務を行うプログラム。サーバーサイド・スクリプトを動作させるためのメモリやCPU性能が重視させる

- 主な機能・流れ
  - Webサーバーから転送されてきたユーザーからのデータを受け取る
  - サーバーサイド・プログラムを実行させる
  - そのデータを加工
  - データベースのデータを検索・加工をした後
  - Webサーバーへ返答

<br>

- `セッション`とは、Webサーバーが発行した`セッションID`をもとに、クライアントのログインからログアウトまでの一連の流れのこと

- `トランザクション`とは、セッションの最小単位のこと

  <br>

予約手続きにおけるセッションとトランザクション

|処理|トランザクション|
|-|-|
|①ログイン|1トランザクション|
|②空室情報の確認|2トランザクション|
|③空室を１部屋減らす|2トランザクション|
|④空室に予約情報を追加|2トランザクション|
|⑤予約確定|2トランザクション|
|⑥ログアウト|3トランザクション| 

<br>

haryu)

- ログイン時にログイン情報を保存するにチェックを入れることでCookieにログイン情報が保存される
- https://tadtadya.com/web-what-is-a-session/
- https://speakerdeck.com/osa/introduction-to-the-internet

- `ライブラリ`とは、同じような処理を何回も書かなくていいように。使いまわせる共通部品
  - FaceBookでログイン

<br>

## 07

<br>

- `データベース管理システム[DBMS(Database Management System)]`とは、`データベース(DB)`に格納されたデータを管理するシステム
- `データベースサーバー(DBサーバー)`とは、DBMSを搭載したサーバー機器のこと
- `DBサーバー`は、基本的に`冗長化構成`を取る
- Webアプリケーションにとって重要なデータの消失をさせないため

<br>

DBサーバーの冗長化とデータの同期

  データベースはWebアプリケーションにより頻繁に更新されるため、冗長化している機器同士で扱うデータベースの内容をいかに最新の状態に同期させるかが重要！

- `ミラーリング`
  - 正規のサーバを`プリンシパル`と呼ぶ
  - 冗長化用に副サーバーを`ミラー`と呼ぶ
  - 更新命令を受けたプリンシパルDBMSが、ミラーのDBMSにも更新命令を転送する
  - ミラーDBMSは更新命令を受け、ミラーのデータベースの更新を`直ちに行う`

- `レプリケーション`
  - 正規のサーバーを`マスタ`と呼ぶ
  - 冗長化用の副サーバーを`スレーブ`と呼ぶ
  - 更新命令を受けたマスタDBMSが、スレーブDBMSに更新履歴を送る
  - スレーブDBMSは更新履歴を受け取り、スレーブのデータベースの更新を`任意のタイミング`で行う

- `シェアードディスク`
  - シェアードディスクのDBMSには正副の概念はない
  - 各DBMSはデータベース共用の機器(`データストレージ`)を持ち、複数のDBMSからそれを更新する
  - 各DBMSから１つのデータストレージに集約するイメージ？

<br>

## 08

<br>

- `キャッシュサーバー`とは、リクエストに対するレスポンスを覚えてお役割を持つプログラム
- `キャッシュ`とは、リクエストに対するレスポンスの記憶のこと
- `キャッシュコンテンツ`とは、文書や画像、動画などのコンテンツのキャッシュのこと
- `クエリキャッシュ`とは、DBMSのデータ要求(クエリ)の結果のこと
- `CDN(Contents Delivery Network)`とは、世界各地に分散して配置されたキャッシュサーバーの集まりのこと。リクエストのネットワーク的に一番近いサーバーが対応する。
- CDNは定期的にWebサーバーからコンテンツのキャッシュを取得している

<br>

キャッシュを利用することで、WebサーバーやDBMSにかかる負荷を減らすことができる！

<br>

## 09

<br>

- `同期通信`
  - `同期通信`とは、クライアントとサーバーが交互に処理を行い、同調して通信を行うこと。
  - サーバーが処理している間、ユーザーに待ち時間が生まれてしまう
  - 送信するデータも多くなるのでサーバーへの負担が増える

- `非同期通信`
  - `Ajax`とは、非同期通信を実現させるための技術
  - Ajaxでは、Webブラウザの代わりにWebブラウザ上で動くJavaScriptが通信を行う
  - Webブラウザ上でクライアントサイド・スクリプトとして動くJavaScriptが直接Webサーバーと通信を行い、取得したデータを使って、表示するHTMLを更新する
  - XMLが使われ、JavaScriptはDOMを使ってXMLやHTMLを操作する
  - HTMLそのものを操作するわけではなく、更新に必要なデータのみをやり取りする
  - そのため、送信するデータ量は同期通信よりも少なく
  - サーバーへの負担も減る

- `Ajax`
  - Webサーバーからのレスポンスを待つ間もクライアント側であるJavaScriptがレスポンスの機能を使った非同期通信が可能になる
  - JavaScriptがレスポンスに左右されない箇所のHTMLを更新したり
  - ユーザーからの入力を受け付けることが出来る

<br>

## 10

<br>

WebプログラミングとはWebアプリケーションを開発すること
- サーバーサイド・スクリプト
  - 効率的な手順での処理
  - サーバーのメモリを無駄遣いしないこと
  - DBMSやSQLの知識
- クライアントサイド・スクリプト
  - ブラウザごとの差異をなくすこと
  - 専用クライアントの開発

<br>

## 11

<br>

- `Web API`とは、Webを通じてユーザーではなくプログラムが直接サービスを利用するための窓口
1. クライアントがWeb APIにWeb経由でデータを送信
2. データを受け取ったWebサーバーがデータを処理
3. 再びWeb経由でクライアントに処理結果のデータを返信

- Web APIとのやりとり手法
  - `XML-RPC`は、XMLを送信することで処理の実行を要求するプロトコル。受信するデータ形式もXMLが使われる
  - `SOAP`は、XMK-RPCを拡張したもの。仕様が複雑
  - `REST`は、プロトコルではなく、設計思想。データ形式がXMLだけではなく、JSONも利用できるため、現在の主流

<br>

## 12

<br>

`マッシュアップ`とは、Web APIを利用して新たなWebサービスを生み出すこと

- マッシュアップのメリット 
  - 他社が膨大のコストをかけて構築したデータを利用できる
  - 自力で準備する必要がな

- マッシュアップのデメリット
  - Web APIの公開を終了されたらサービスが存続できなくなる
  - Web APIの仕様変更が起きれば、サービスを修正する必要がある
  - 常に利用させてもらっているという意識を持つように！

<br>

## 13

<br>

[復習]

`CGI`とは、Webサーバーがクライアントからの要求に応じてサーバーサイド・スクリプトを起動させるための仕組み。CGIプログラムに用いられる言語はWebサーバー上で実行可能なものであればなんでも良い。また、APサーバーを用意しなくてもWebサーバー上でサーバーサイド・スクリプトを実行できるので、小規模な動的ページ作成でも使われている

Webサーバーはクライアントからのリクエストを受けると対応するコンテンツを配信するが、予めCGI用のプログラム(CGIプログラム)として定義されたコンテンツについてはそのままクライアントに返信せず、`それをWebサーバー上で実行した結果`を返信する

<br>

- データの渡し方
  - クライアントがCGIの場所(URL)にアクセスすることで、対象となるプログラムが起動される
  - アクセスの際に、クライアントからデータを送信できる

- `コマンドライン引数渡し`
  - データを直接渡す方法
  - URLの末尾に「？」を付け、その後にデータを「＋」で区切り並べる
  - `https://example.com/program.cgi?データ1+データ2`

<br>

  - `パス渡し`
    - データをリクエストURLの階層構造に含めて渡す方法
    - URLの後に、「/」で区切り、データを並べる
    - `PATH_INFO`という変数に格納され、CGIプログラムが起動後にそこから変数を取り出す
    - `https://example.com/program.cgi/データ1/データ2`

<br>

- `GETメソッド`
  - URLの末尾に「?データ名1=データ1&データ名2=データ2」のような形で追加する
  - `QUERY_STRING`変数に格納される
  - `https://example.com/program.cgi/?データ名1=データ1&データ名2=データ2`

<br>

- `POSTメソッド`
  - リクエストとしてURLとは別にデータを送る
  - URLを見ても送信データがわからないため、利用が安全

<br>

## 14

<br>

- サーバー間の連携
  - CGIを利用せずにサーバーサイド・スクリプトを動作させる場合は、WebサーバーがAPサーバーにデータ処理を依頼し、APサーバーがサーバーサイド・スクリプトを動作させる流れになる
  - サーバー間の連携はネットワーク通信を使用し行われる
  - Webサーバーがクライアントに
  - Apサーバーがサーバに
  - APサーバーとDBMS間も同様

- サーバー同士の通信
  - リクエストを送る側がクライアント
  - レスポンスを送る側がサーバ
  - IPアドレスとポート番号を指定してTCP/IP通信で行う
  - APサーバーやDBMSにも予めポート番号が割り当てられているので、クライアントはそのポート番号を指定する
  - 自らの稼働しているサーバー機器を表す特殊なIPアドレス「`127.0.0.1`」

- 利用するプロトコル

  <br>

  |サーバー|プロトコル|
  |-|-|
  |APサーバー|AJP、WebSocte|
  |DBMS|独自|

  <br>

  - `ODBC(Open Database Connectivity)`
    - DBMSは独自のプロトコルを使用するため、各APサーバーがそのすべてに対応することは難しい。そのため、`ODBC`というAPI(ドライバ)を利用することでさまざまなDBMSの独自プロトコルに対応することができる